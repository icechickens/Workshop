<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECSバッチサーバアーキテクチャ</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .mermaid {
            display: flex;
            justify-content: center;
        }
        .code-container {
            margin-top: 40px;
            background-color: #f8f8f8;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        pre {
            white-space: pre-wrap;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ECSバッチサーバアーキテクチャ</h1>
        
        <div class="mermaid">
graph LR
    %% スタイル定義
    classDef aws fill:#FF9900,stroke:#232F3E,color:white
    classDef client fill:#D5E8D4,stroke:#82B366
    classDef cluster fill:#E1F5FE,stroke:#4FC3F7
    classDef vpc fill:#F5F5F5,stroke:#BDBDBD
    classDef subnet fill:#FFF9C4,stroke:#FFF176
    classDef ecsCluster fill:#E8F5E9,stroke:#81C784

    %% ノード定義
    Client[クライアント]:::client
    
    subgraph AWS["AWS クラウド"]:::cluster
        EventBridge[EventBridge<br>スケジュール]:::aws
        SQS[SQS<br>ジョブキュー]:::aws
        
        subgraph VPC["VPC"]:::vpc
            subgraph PrivateSubnet["プライベートサブネット"]:::subnet
                subgraph ECSCluster["ECS クラスター"]:::ecsCluster
                    Fargate[Fargate]:::aws
                    Container1[バッチ処理<br>コンテナ1]:::aws
                    Container2[バッチ処理<br>コンテナ2]:::aws
                    Container3[バッチ処理<br>コンテナ3]:::aws
                end
                
                RDS[RDS<br>データベース]:::aws
            end
        end
        
        S3[S3バケット<br>入出力データ]:::aws
        CloudWatch[CloudWatch<br>モニタリング]:::aws
        IAM[IAM<br>ロール]:::aws
    end
    
    %% 接続関係
    Client -->|バッチ処理<br>リクエスト| EventBridge
    EventBridge -->|スケジュール<br>トリガー| SQS
    SQS -->|ジョブ取得| Container1
    SQS -->|ジョブ取得| Container2
    SQS -->|ジョブ取得| Container3
    
    Fargate -.->|実行環境| Container1
    Fargate -.->|実行環境| Container2
    Fargate -.->|実行環境| Container3
    
    Container1 -->|データ読み書き| S3
    Container2 -->|データ読み書き| S3
    Container3 -->|データ読み書き| S3
    
    Container1 -->|データ処理| RDS
    Container2 -->|データ処理| RDS
    Container3 -->|データ処理| RDS
    
    Container1 -->|ログ/メトリクス| CloudWatch
    Container2 -->|ログ/メトリクス| CloudWatch
    Container3 -->|ログ/メトリクス| CloudWatch
    
    IAM -.->|権限付与| Container1
    IAM -.->|権限付与| Container2
    IAM -.->|権限付与| Container3
        </div>
        
        <div class="code-container">
            <h2>Mermaidコード</h2>
            <pre><code>graph LR
    %% スタイル定義
    classDef aws fill:#FF9900,stroke:#232F3E,color:white
    classDef client fill:#D5E8D4,stroke:#82B366
    classDef cluster fill:#E1F5FE,stroke:#4FC3F7
    classDef vpc fill:#F5F5F5,stroke:#BDBDBD
    classDef subnet fill:#FFF9C4,stroke:#FFF176
    classDef ecsCluster fill:#E8F5E9,stroke:#81C784

    %% ノード定義
    Client[クライアント]:::client
    
    subgraph AWS["AWS クラウド"]:::cluster
        EventBridge[EventBridge<br>スケジュール]:::aws
        SQS[SQS<br>ジョブキュー]:::aws
        
        subgraph VPC["VPC"]:::vpc
            subgraph PrivateSubnet["プライベートサブネット"]:::subnet
                subgraph ECSCluster["ECS クラスター"]:::ecsCluster
                    Fargate[Fargate]:::aws
                    Container1[バッチ処理<br>コンテナ1]:::aws
                    Container2[バッチ処理<br>コンテナ2]:::aws
                    Container3[バッチ処理<br>コンテナ3]:::aws
                end
                
                RDS[RDS<br>データベース]:::aws
            end
        end
        
        S3[S3バケット<br>入出力データ]:::aws
        CloudWatch[CloudWatch<br>モニタリング]:::aws
        IAM[IAM<br>ロール]:::aws
    end
    
    %% 接続関係
    Client -->|バッチ処理<br>リクエスト| EventBridge
    EventBridge -->|スケジュール<br>トリガー| SQS
    SQS -->|ジョブ取得| Container1
    SQS -->|ジョブ取得| Container2
    SQS -->|ジョブ取得| Container3
    
    Fargate -.->|実行環境| Container1
    Fargate -.->|実行環境| Container2
    Fargate -.->|実行環境| Container3
    
    Container1 -->|データ読み書き| S3
    Container2 -->|データ読み書き| S3
    Container3 -->|データ読み書き| S3
    
    Container1 -->|データ処理| RDS
    Container2 -->|データ処理| RDS
    Container3 -->|データ処理| RDS
    
    Container1 -->|ログ/メトリクス| CloudWatch
    Container2 -->|ログ/メトリクス| CloudWatch
    Container3 -->|ログ/メトリクス| CloudWatch
    
    IAM -.->|権限付与| Container1
    IAM -.->|権限付与| Container2
    IAM -.->|権限付与| Container3</code></pre>
        </div>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: false,
                htmlLabels: true
            }
        });
    </script>
</body>
</html>
